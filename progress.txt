# Codebase Patterns

## Tech Stack
- React 18.3.1 + TypeScript 5.5.3 + Vite 5.4.1
- Supabase (PostgreSQL, Auth, Edge Functions, Storage, Realtime)
- Tailwind CSS + shadcn/ui (Radix primitives) + Lucide icons
- TanStack Query v5 for server state
- React Router DOM v6 for routing
- Stripe for payments (subscriptions + campaigns)
- Playwright for E2E testing (7 suites)
- Cloudflare Pages for hosting

## Project Structure
- src/components/ui/ — shadcn/ui base components (do NOT modify these directly)
- src/components/[feature]/ — feature-specific components
- src/hooks/ — 116 custom hooks (use-*.ts naming)
- src/lib/ — utility libraries (errorHandler, safeStorage, utils)
- src/contexts/ — React contexts (AuthContext is the primary one)
- src/pages/ — 62 route page components
- src/integrations/supabase/ — Supabase client + generated types
- supabase/functions/ — 76 edge functions with _shared/ middleware
- supabase/migrations/ — 151 SQL migrations

## Key Conventions
- Environment variables: use import.meta.env (NOT process.env) — Vite project
- localStorage: use safeStorage wrapper from @/lib/safeStorage (NOT direct access)
- Error handling: use handleError/withErrorHandling from @/lib/errorHandler
- Logging: use `createLogger('ComponentName')` from `@/lib/logger` (NOT raw console.*)
- Auth: use useAuth() from @/contexts/AuthContext
- Subscriptions: use useSubscription() hook + PremiumGate component
- Named exports preferred over default exports (except pages)
- 2-space indentation, single quotes, semicolons
- Unit tests: vitest + @testing-library/react, run with `npm run test:unit`
- Test files go in `__tests__` directories alongside source (e.g., `src/lib/__tests__/`)
- ESLint `no-console` rule is `warn` — only `logger.ts` and `errorSuppression.ts` may use raw console (with eslint-disable comments)
- When replacing console calls guarded by `import.meta.env.DEV`: keep guard for warn/error (not suppressed in prod), remove guard for debug/info (suppressed by logger)

## Build & Quality Commands
- npm run dev — dev server on localhost:8080
- npm run build — production build (strips console.* via esbuild)
- npm run lint — ESLint
- npm run type-check — TypeScript (relaxed mode)
- npm run type-check:strict — TypeScript (strict mode, partial files)
- npm run validate — lint + typecheck combined
- npm test — Playwright E2E tests

## Edge Function Patterns
- CORS middleware from _shared/cors.ts
- Rate limiting from _shared/rateLimit.ts (100 req/15min default)
- Input validation from _shared/validation.ts
- 18 functions have verify_jwt=false (scrapers, crawlers, webhooks)

## Database Patterns
- RLS enabled on all tables
- Public read for content tables (events, restaurants, attractions)
- Authenticated write with role checks
- Admin-only for sensitive operations
- Auto-update timestamps via triggers

## Known Technical Debt (as of PRD creation)
- 682 instances of 'any' type (TypeScript relaxed mode)
- 188 files with raw console.log/error/warn
- 14 files use localStorage directly (should use safeStorage)
- 18 unauthenticated edge functions (need audit)
- No unit tests (only Playwright E2E)
- No CI/CD PR validation (only event-crawler workflow)
- Error tracking placeholder (Sentry not configured)
- PearsonASUS file naming artifacts from merge
- SearchTrafficDashboard commented out (missing migrations)
- TODOs: user preferences server-side, scraping job persistence, distance calculation

---

## Progress Log

## 2026-02-06 — PRD Created
- Created prd.json with 30 user stories for enterprise readiness
- Created progress.txt with codebase patterns
- **Learnings for future iterations:**
  - The codebase has strong foundations but critical operational gaps
  - CI/CD and observability are the highest-priority blockers
  - TypeScript strict mode migration should start from src/lib/ (imported everywhere)
  - Console cleanup needs a structured logger utility first (US-005) before bulk replacement
  - Edge function security is a mix: some intentionally unauthenticated (webhooks), some should be locked down

## 2026-02-12 — US-005
- Created `src/lib/logger.ts` with structured logging utility
- Log levels: debug, info, warn, error
- Accepts context: `{ component: string, action: string, metadata?: Record<string, unknown> }`
- Production filtering: debug and info are no-ops when `import.meta.env.PROD` is true
- Development logs include ISO timestamp, level, component, action, and message
- Exports `logger` (default instance) and `createLogger(component)` factory
- Created `src/lib/__tests__/logger.test.ts` with 14 test cases covering:
  - All four log levels in development mode
  - Context formatting (component, action, timestamp, metadata)
  - `createLogger` component scoping and override behavior
  - All log levels on scoped logger
- Files changed: `src/lib/logger.ts` (new), `src/lib/__tests__/logger.test.ts` (new)
- All 50 unit tests pass, typecheck passes, lint clean on new files
- **Learnings for future iterations:**
  - `console.debug/info/warn/error` map directly to log levels (don't use `console.log` for structured output)
  - Don't add `eslint-disable-next-line no-console` comments until the `no-console` rule is actually added (US-006) — they cause "unused directive" warnings
  - The logger is the only file that should use raw console methods — all other files should import from `@/lib/logger`
  - `import.meta.env.PROD` is `false` in Vitest (DEV is true), so production filtering can't be directly tested in unit tests
---

## 2026-02-12 — US-006
- Added `'no-console': 'warn'` rule to `eslint.config.js`
- Replaced all `console.log/warn/error` calls in 17 `src/lib/` files with structured logger from `@/lib/logger`
- Added `eslint-disable-next-line no-console` comments to `logger.ts` (4 lines — legitimate console consumer) and `errorSuppression.ts` (4 lines — console method wrapper)
- Updated `src/lib/__tests__/errorHandler.test.ts` to match new logger output format (metadata wrapped in objects)
- Files changed: `eslint.config.js`, `src/lib/logger.ts`, `src/lib/analytics-tracker.ts`, `src/lib/deferredLoader.ts`, `src/lib/email-integration.ts`, `src/lib/errorHandler.ts`, `src/lib/errorSuppression.ts`, `src/lib/errorTracking.ts`, `src/lib/eventSubmissionService.ts`, `src/lib/lazyLoad.ts`, `src/lib/performance.ts`, `src/lib/safeStorage.ts`, `src/lib/security/middleware.ts`, `src/lib/security/ownership.ts`, `src/lib/sitemap.ts`, `src/lib/sitemapEnhanced.ts`, `src/lib/timezone.ts`, `src/lib/timezone-PearsonASUS.ts`, `src/lib/tracking.ts`, `src/lib/__tests__/errorHandler.test.ts`
- All 50 unit tests pass, typecheck passes, lint passes (no console warnings in src/lib/ non-test files)
- **Learnings for future iterations:**
  - `errorSuppression.ts` intentionally wraps/overrides `console.warn` and `console.error` — these need `eslint-disable` comments, not logger replacements
  - When replacing `console.error` calls that tests assert against, the test expectations must be updated to match the logger's formatted output (`log.error(msg, { action, metadata })` passes metadata as the second arg to `console.error`)
  - For warn/error log levels, keep existing `import.meta.env.DEV` guards since the logger does NOT suppress those in production; for debug/info levels, remove the guards since the logger suppresses them in production
  - The `no-console` rule is set to `warn` (not `error`) to allow gradual migration in other directories (hooks, components, pages, contexts)
---

## 2026-02-12 — US-007
- Replaced all raw `console.log/warn/error` calls in `src/hooks/` with structured logger from `@/lib/logger`
- Each hook uses `createLogger('hookName')` factory to create a scoped logger instance
- 89 hook files modified, 717 insertions, 470 deletions
- Zero `no-console` lint warnings remain in `src/hooks/`
- All 50 unit tests pass, typecheck passes
- Files changed: 89 files in `src/hooks/` (all hooks that previously had console calls)
- **Learnings for future iterations:**
  - The console calls in `useNLPSearch.ts` were inside JSDoc comments (not actual code) — grep carefully distinguishes real calls from documentation examples
  - The working tree had all changes pre-applied from a previous incomplete iteration — always check `git diff` before starting work to avoid duplicating effort
  - Pattern for logger in hooks: `import { createLogger } from '@/lib/logger'; const log = createLogger('useHookName');` at top of file, then `log.error('message', { action: 'methodName', metadata: { error } })` in catch blocks
  - `console.log` (debug output) → `log.debug()`, `console.warn` → `log.warn()`, `console.error` → `log.error()`
  - Pre-existing lint errors (117 errors, 95 warnings) are unrelated to console usage — they're `no-explicit-any`, `no-unused-vars`, and `react-hooks/exhaustive-deps` warnings
---
