# ================================================================
# iOS App Store Screenshots via Fastlane Snapshot
# ================================================================
#
# Automatically generates App Store screenshots for all required
# device sizes using Fastlane Snapshot + XCUITest.
#
# Devices captured:
#   - iPhone 16 Pro Max (6.9")
#   - iPhone 15 Pro Max (6.7")
#   - iPad Pro 13" (M4)
#
# Screens captured (8 per device):
#   01. Home feed
#   02. Restaurants
#   03. Search
#   04. Map
#   05. Favorites
#   06. Profile
#   07. Event Detail
#   08. Restaurant Detail
#
# Total: ~24 screenshots per run (3 devices x 8 screens)
#
# Triggers:
#   - Manual dispatch (workflow_dispatch) with optional device filter
#   - Push to ios/ on release tags (v*-screenshots)
#
# Output: Uploaded as a GitHub Actions artifact (screenshots.zip)
#
# ================================================================

name: iOS App Store Screenshots

on:
  # Manual trigger with optional parameters
  workflow_dispatch:
    inputs:
      devices:
        description: 'Devices to capture (comma-separated, or "all")'
        required: false
        default: 'all'
        type: string
      locale:
        description: 'Locale for screenshots'
        required: false
        default: 'en-US'
        type: string

env:
  XCODE_VERSION: '26.0'
  PROJECT_DIR: 'ios'
  SCHEME: 'DesMoinesInsiderUITests'
  RUBY_VERSION: '3.2'

jobs:
  # ================================================================
  # Generate App Store screenshots
  # ================================================================
  screenshots:
    name: Generate App Store Screenshots
    runs-on: macos-15
    timeout-minutes: 90

    steps:
      # ────────────────────────────────────────────
      # 1. Checkout
      # ────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      # ────────────────────────────────────────────
      # 2. Select Xcode
      # ────────────────────────────────────────────
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer"
          else
            echo "::warning::Xcode ${XCODE_VERSION} not found. Using default."
            ls -d /Applications/Xcode*.app 2>/dev/null || echo "No Xcode found"
          fi
          echo "Xcode: $(xcodebuild -version | head -1)"
          echo "Swift: $(swift --version | head -1)"

      # ────────────────────────────────────────────
      # 3. Install tools
      # ────────────────────────────────────────────
      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ${{ env.PROJECT_DIR }}/fastlane

      - name: Install Fastlane
        working-directory: ${{ env.PROJECT_DIR }}/fastlane
        run: bundle install

      # ────────────────────────────────────────────
      # 4. Generate secrets & project
      # ────────────────────────────────────────────
      - name: Generate Supabase secrets for screenshots
        working-directory: ${{ env.PROJECT_DIR }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          chmod +x scripts/generate-secrets.sh
          bash scripts/generate-secrets.sh

      - name: Generate Xcode project
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          xcodegen generate
          echo "Xcode project generated"
          ls -la DesMoinesInsider.xcodeproj/

      # ────────────────────────────────────────────
      # 5. Resolve dependencies
      # ────────────────────────────────────────────
      - name: Resolve Swift Package Manager dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          xcodebuild -resolvePackageDependencies \
            -project DesMoinesInsider.xcodeproj \
            -scheme DesMoinesInsider \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm-cache"
          echo "SPM dependencies resolved"

      # ────────────────────────────────────────────
      # 6. Boot simulators
      # ────────────────────────────────────────────
      - name: List available simulators
        run: |
          xcrun simctl list devices available --json | \
            python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data.get('devices', {}).items():
            for d in devices:
              if d.get('isAvailable'):
                print(f\"  {d['name']} ({d['udid']}) - {runtime}\")
          " | head -40
          echo "---"

      - name: Create missing simulators
        run: |
          # Ensure all required simulators exist.
          # macOS runners may not have every device type pre-created.
          DEVICES=(
            "iPhone 16 Pro Max"
            "iPhone 15 Pro Max"
            "iPad Pro 13-inch (M4)"
          )

          # Get the latest iOS runtime
          LATEST_RUNTIME=$(xcrun simctl list runtimes --json | \
            python3 -c "
          import json, sys
          runtimes = json.load(sys.stdin).get('runtimes', [])
          ios = [r for r in runtimes if 'iOS' in r.get('name', '') and r.get('isAvailable')]
          if ios:
            print(ios[-1]['identifier'])
          ")

          echo "Latest iOS runtime: $LATEST_RUNTIME"

          if [ -z "$LATEST_RUNTIME" ]; then
            echo "::warning::No iOS runtime found. Snapshot may fail."
            exit 0
          fi

          for DEVICE in "${DEVICES[@]}"; do
            # Check if simulator already exists
            EXISTS=$(xcrun simctl list devices --json | \
              python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          found = False
          for runtime, devices in data.get('devices', {}).items():
            for d in devices:
              if d['name'] == '$DEVICE' and d.get('isAvailable'):
                found = True
                break
          print('yes' if found else 'no')
          ")

            if [ "$EXISTS" = "yes" ]; then
              echo "Simulator exists: $DEVICE"
            else
              echo "Creating simulator: $DEVICE"
              # Get the device type identifier
              DEVICE_TYPE=$(xcrun simctl list devicetypes --json | \
                python3 -c "
          import json, sys
          types = json.load(sys.stdin).get('devicetypes', [])
          name = '$DEVICE'
          for t in types:
            if t['name'] == name:
              print(t['identifier'])
              break
          ")

              if [ -n "$DEVICE_TYPE" ]; then
                xcrun simctl create "$DEVICE" "$DEVICE_TYPE" "$LATEST_RUNTIME" || \
                  echo "::warning::Failed to create simulator: $DEVICE"
              else
                echo "::warning::Device type not found: $DEVICE"
              fi
            fi
          done

      - name: Pre-boot simulators
        run: |
          # Boot all simulators in parallel before Fastlane runs.
          # This avoids Fastlane's sequential boot which wastes ~5 min per device.
          echo "Pre-booting simulators..."
          DEVICES=(
            "iPhone 16 Pro Max"
            "iPhone 15 Pro Max"
            "iPad Pro 13-inch (M4)"
          )
          for DEVICE in "${DEVICES[@]}"; do
            UDID=$(xcrun simctl list devices available --json | \
              python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data.get('devices', {}).items():
            for d in devices:
              if d['name'] == '$DEVICE' and d.get('isAvailable'):
                print(d['udid'])
                break
          ")
            if [ -n "$UDID" ]; then
              echo "Booting $DEVICE ($UDID) in background..."
              xcrun simctl boot "$UDID" 2>/dev/null || true
            fi
          done
          # Wait for all simulators to finish booting
          echo "Waiting for simulators to finish booting..."
          for DEVICE in "${DEVICES[@]}"; do
            UDID=$(xcrun simctl list devices available --json | \
              python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data.get('devices', {}).items():
            for d in devices:
              if d['name'] == '$DEVICE' and d.get('isAvailable'):
                print(d['udid'])
                break
          ")
            if [ -n "$UDID" ]; then
              xcrun simctl bootstatus "$UDID" -b 2>/dev/null || true
              echo "  $DEVICE booted"
            fi
          done
          echo "All simulators ready"

      # ────────────────────────────────────────────
      # 7. Run Fastlane Snapshot
      # ────────────────────────────────────────────
      - name: Capture screenshots
        working-directory: ${{ env.PROJECT_DIR }}/fastlane
        env:
          SNAPSHOT_DEVICES: ${{ github.event.inputs.devices || 'all' }}
          SNAPSHOT_LOCALE: ${{ github.event.inputs.locale || 'en-US' }}
        run: |
          set -o pipefail

          echo "=== Starting Fastlane Snapshot ==="
          echo "Devices: $SNAPSHOT_DEVICES"
          echo "Locale: $SNAPSHOT_LOCALE"
          echo ""

          # Run the snapshot lane (Fastlane runs from ios/fastlane/)
          # Fail hard on errors so we get fast feedback instead of hour-long retry loops.
          bundle exec fastlane ios screenshots 2>&1 | tee "$RUNNER_TEMP/snapshot.log"

          # Report results (Fastlane outputs to ios/screenshots/, one level up)
          echo ""
          echo "=== Screenshot Results ==="
          if [ -d "../screenshots" ]; then
            TOTAL=$(find ../screenshots -name "*.png" | wc -l | xargs)
            echo "Total screenshots captured: $TOTAL"
            echo ""
            echo "Screenshots by device:"
            find ../screenshots -name "*.png" -exec dirname {} \; | sort -u | while read dir; do
              COUNT=$(find "$dir" -name "*.png" | wc -l | xargs)
              echo "  $dir: $COUNT screenshots"
            done
          else
            echo "::warning::No screenshots directory found at ../screenshots"
          fi

      # ────────────────────────────────────────────
      # 8. Upload screenshots as artifact
      # ────────────────────────────────────────────
      - name: Upload screenshots artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-store-screenshots
          path: ${{ env.PROJECT_DIR }}/screenshots/
          retention-days: 30
          if-no-files-found: warn

      # ────────────────────────────────────────────
      # 9. Upload logs on failure
      # ────────────────────────────────────────────
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-logs
          path: |
            ${{ env.PROJECT_DIR }}/fastlane/logs/
            ${{ env.PROJECT_DIR }}/fastlane/report.xml
          retention-days: 7
          if-no-files-found: ignore

      # ────────────────────────────────────────────
      # 10. Summary
      # ────────────────────────────────────────────
      - name: Job summary
        if: always()
        run: |
          echo "## App Store Screenshots" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SCREENSHOT_DIR="${{ env.PROJECT_DIR }}/screenshots"
          if [ -d "$SCREENSHOT_DIR" ]; then
            TOTAL=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l | xargs)
            echo "**Total screenshots captured:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Devices" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Device | Size | Screenshots |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| iPhone 16 Pro Max | 6.9\" | Required |" >> $GITHUB_STEP_SUMMARY
            echo "| iPhone 15 Pro Max | 6.7\" | Required |" >> $GITHUB_STEP_SUMMARY
            echo "| iPad Pro 13\" (M4) | 13\" | Required |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Screens" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Home Feed" >> $GITHUB_STEP_SUMMARY
            echo "2. Restaurants" >> $GITHUB_STEP_SUMMARY
            echo "3. Search" >> $GITHUB_STEP_SUMMARY
            echo "4. Map" >> $GITHUB_STEP_SUMMARY
            echo "5. Favorites" >> $GITHUB_STEP_SUMMARY
            echo "6. Profile" >> $GITHUB_STEP_SUMMARY
            echo "7. Event Detail" >> $GITHUB_STEP_SUMMARY
            echo "8. Restaurant Detail" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download the **app-store-screenshots** artifact to get all images." >> $GITHUB_STEP_SUMMARY
          else
            echo "No screenshots were generated." >> $GITHUB_STEP_SUMMARY
          fi
