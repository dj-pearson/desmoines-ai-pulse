name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # Job 1: PR Information
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR stats
        run: |
          echo "üìä Pull Request Statistics"
          echo "=========================="
          echo "Branch: ${{ github.head_ref }}"
          echo "Base: ${{ github.base_ref }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"
          echo ""
          echo "Changed files:"
          git diff --name-only origin/${{ github.base_ref }}...HEAD
          echo ""
          echo "Lines changed:"
          git diff --shortstat origin/${{ github.base_ref }}...HEAD

  # Job 2: Validate Code Quality
  validate:
    name: Validate Changes
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+.*TODO|^\+.*FIXME"; then
            echo "‚ö†Ô∏è New TODO/FIXME comments found in this PR"
          else
            echo "‚úÖ No new TODO/FIXME comments"
          fi
        continue-on-error: true

  # Job 3: Bundle Size Check
  bundle-size:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Analyze bundle size
        run: |
          echo "üì¶ Bundle Size Report"
          echo "===================="
          echo ""
          echo "Individual chunks:"
          du -h dist/assets/*.js | sort -h
          echo ""
          echo "Total size:"
          du -sh dist
          echo ""
          echo "Gzipped estimates:"
          for file in dist/assets/*.js; do
            gzip -c "$file" | wc -c | awk '{printf "%.1f KB - %s\n", $1/1024, FILENAME}' FILENAME="$file"
          done | sort -h

      - name: Check bundle size limit
        run: |
          TOTAL_SIZE=$(du -s dist | cut -f1)
          MAX_SIZE=3000  # 3MB uncompressed (~500KB gzipped)

          if [ $TOTAL_SIZE -gt $MAX_SIZE ]; then
            echo "‚ùå Bundle size ($TOTAL_SIZE KB) exceeds limit ($MAX_SIZE KB)"
            exit 1
          else
            echo "‚úÖ Bundle size ($TOTAL_SIZE KB) is within limit ($MAX_SIZE KB)"
          fi

  # Job 4: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: |
          echo "üîí Security Audit"
          echo "================"
          npm audit --production || true
          echo ""
          echo "Checking for critical vulnerabilities..."
          npm audit --audit-level=critical --production

  # Job 5: Preview Deployment (optional)
  # deploy-preview:
  #   name: Deploy Preview
  #   runs-on: ubuntu-latest
  #   needs: [validate, bundle-size]
  #   timeout-minutes: 10
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Build application
  #       run: npm run build
  #       env:
  #         VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  #         VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
  #
  #     - name: Deploy to Cloudflare Pages (Preview)
  #       uses: cloudflare/pages-action@v1
  #       with:
  #         apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  #         accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  #         projectName: desmoines-ai-pulse
  #         directory: dist
  #         gitHubToken: ${{ secrets.GITHUB_TOKEN }}
  #         branch: ${{ github.head_ref }}
  #
  #     - name: Comment preview URL
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           github.rest.issues.createComment({
  #             issue_number: context.issue.number,
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             body: 'üöÄ Preview deployment is ready!\n\nView your changes at: [Preview URL]'
  #           })
