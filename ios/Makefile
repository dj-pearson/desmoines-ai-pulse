# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Des Moines Insider â€” Native iOS Build Targets
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Usage:
#   make setup          # First-time setup
#   make build          # Build for Simulator
#   make open           # Open in Xcode
#   make beta           # Ship to TestFlight
#   make release        # Ship to App Store Connect
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: help setup secrets generate build open clean beta release

SHELL := /bin/bash
PROJECT := DesMoinesInsider.xcodeproj
SCHEME := DesMoinesInsider

# â”€â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
help: ## Show this help
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# â”€â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setup: ## First-time project setup (install tools + generate project)
	@echo "=== Installing dependencies ==="
	@command -v xcodegen &> /dev/null || brew install xcodegen
	@echo "=== Copying secrets template ==="
	@test -f Secrets.xcconfig || cp Secrets.xcconfig.example Secrets.xcconfig
	@echo "âš ï¸  Edit Secrets.xcconfig with your Supabase credentials"
	@echo ""
	$(MAKE) generate
	@echo ""
	@echo "âœ… Setup complete. Run 'make open' to open in Xcode."

# â”€â”€â”€ Generate Secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
secrets: ## Generate Secrets.generated.swift from env vars or Secrets.xcconfig
	@bash scripts/generate-secrets.sh

# â”€â”€â”€ Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
generate: secrets ## Generate Xcode project from project.yml (runs secrets first)
	xcodegen generate
	@echo "âœ… $(PROJECT) generated"

# â”€â”€â”€ Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
build: generate ## Build for iOS Simulator (no signing)
	xcodebuild build \
		-project $(PROJECT) \
		-scheme $(SCHEME) \
		-configuration Debug \
		-destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
		CODE_SIGN_IDENTITY="" \
		CODE_SIGNING_REQUIRED=NO \
		CODE_SIGNING_ALLOWED=NO \
		| xcpretty --color
	@echo "âœ… Simulator build succeeded"

# â”€â”€â”€ Open in Xcode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
open: generate ## Generate project and open in Xcode
	open $(PROJECT)

# â”€â”€â”€ Fastlane: TestFlight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
beta: ## Build and upload to TestFlight
	@if command -v bundle &> /dev/null; then \
		bundle exec fastlane ios beta; \
	elif command -v fastlane &> /dev/null; then \
		fastlane ios beta; \
	else \
		echo "âš ï¸  Fastlane not found. Install with: gem install fastlane"; \
	fi

# â”€â”€â”€ Fastlane: App Store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
release: ## Build and upload to App Store Connect
	@if command -v bundle &> /dev/null; then \
		bundle exec fastlane ios release; \
	elif command -v fastlane &> /dev/null; then \
		fastlane ios release; \
	else \
		echo "âš ï¸  Fastlane not found. Install with: gem install fastlane"; \
	fi

# â”€â”€â”€ Clean â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clean: ## Remove build artifacts and generated project
	rm -rf build/
	rm -rf $(PROJECT)
	rm -rf DerivedData/
	rm -rf .build/
	@echo "ğŸ§¹ Cleaned. Run 'make setup' to regenerate."
