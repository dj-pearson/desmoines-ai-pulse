# Fastfile â€” Native Swift iOS build, sign, and upload
#
# Setup:
#   gem install fastlane
#   brew install xcodegen
#
# Usage:
#   fastlane ios generate       # Generate Xcode project from project.yml
#   fastlane ios build_debug    # Build for Simulator (no signing)
#   fastlane ios beta           # Build + upload to TestFlight
#   fastlane ios release        # Build + upload to App Store Connect
#
# IMPORTANT: Supabase credentials are injected via Secrets.generated.swift,
# NOT via build settings. Run scripts/generate-secrets.sh before building.
# The generate lane does this automatically.

default_platform(:ios)

PROJECT_PATH = "DesMoinesInsider.xcodeproj"
SCHEME = "DesMoinesInsider"
BUNDLE_ID = "com.desmoines.aipulse"
IPA_OUTPUT = "./build"
IPA_NAME = "DesMoinesInsider.ipa"

platform :ios do

  # ============================================================================
  # Generate secrets + Xcode project from project.yml
  # ============================================================================

  desc "Generate Xcode project using XcodeGen (also runs secrets script)"
  lane :generate do
    # Generate Secrets.generated.swift from env vars / Secrets.xcconfig
    sh("cd .. && bash scripts/generate-secrets.sh")
    sh("cd .. && xcodegen generate")
    # Keep SnapshotHelper.swift in sync with the installed Fastlane version
    # Copy directly from the gem assets (fastlane snapshot update requires interactive confirmation)
    fastlane_gem = Gem::Specification.find_by_name('fastlane').gem_dir
    source = File.join(fastlane_gem, "snapshot", "lib", "assets", "SnapshotHelper.swift")
    dest = File.expand_path("../DesMoinesInsiderUITests/SnapshotHelper.swift", Dir.pwd)
    FileUtils.cp(source, dest)
    UI.success("Updated SnapshotHelper.swift from Fastlane #{Fastlane::VERSION}")
    UI.success("Xcode project generated from project.yml")
  end

  # ============================================================================
  # Build for Simulator (debug, no signing)
  # ============================================================================

  desc "Build for iOS Simulator (no signing required)"
  lane :build_debug do
    generate

    xcodebuild(
      project: PROJECT_PATH,
      scheme: SCHEME,
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16,OS=latest",
      build_settings: {
        "CODE_SIGN_IDENTITY" => "",
        "CODE_SIGNING_REQUIRED" => "NO",
        "CODE_SIGNING_ALLOWED" => "NO",
      },
      xcargs: "-resolvePackageDependencies"
    )

    UI.success("Debug build succeeded!")
  end

  # ============================================================================
  # Build & upload to TestFlight
  # ============================================================================

  desc "Build and upload to TestFlight"
  lane :beta do
    generate

    # Increment build number
    increment_build_number(
      xcodeproj: PROJECT_PATH
    )

    build_app(
      project: PROJECT_PATH,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: IPA_OUTPUT,
      output_name: IPA_NAME,
      clean: true
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    UI.success("Successfully uploaded to TestFlight!")
  end

  # ============================================================================
  # Build & upload to App Store Connect
  # ============================================================================

  desc "Build and upload to App Store Connect"
  lane :release do
    generate

    # Increment build number
    increment_build_number(
      xcodeproj: PROJECT_PATH
    )

    build_app(
      project: PROJECT_PATH,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: IPA_OUTPUT,
      output_name: IPA_NAME,
      clean: true
    )

    upload_to_app_store(
      force: false,
      submit_for_review: false,
      automatic_release: false,
      precheck_include_in_app_purchases: false
    )

    UI.success("Successfully uploaded to App Store Connect!")
  end

  # ============================================================================
  # Automated App Store Screenshots via Fastlane Snapshot
  # ============================================================================
  #
  # Generates screenshots for all required App Store device sizes:
  #   - iPhone 6.9" (iPhone 16 Pro Max)
  #   - iPhone 6.7" (iPhone 15 Pro Max)
  #   - iPhone 6.5" (iPhone 14 Plus)
  #   - iPad Pro 12.9" (6th gen)
  #   - iPad Pro 13" (M4)
  #
  # The XCUITest target (DesMoinesInsiderUITests) navigates each screen
  # and captures screenshots via the SnapshotHelper.
  #
  # Output: ios/fastlane/screenshots/<locale>/<device>/
  # ============================================================================

  desc "Generate App Store screenshots for all required device sizes"
  lane :screenshots do
    generate

    capture_screenshots(
      project: PROJECT_PATH,
      scheme: "DesMoinesInsiderUITests",
      output_directory: "./screenshots",
      clear_previous_screenshots: true,
      override_status_bar: true,
      override_status_bar_arguments: "--time 9:41 --batteryState charged --batteryLevel 100 --wifiBars 3 --cellularBars 4",
      stop_after_first_error: false,
      devices: [
        "iPhone 16 Pro Max",
        "iPhone 15 Pro Max",
        "iPhone 14 Plus",
        "iPad Pro (12.9-inch) (6th generation)",
        "iPad Pro 13-inch (M4)",
      ],
      languages: ["en-US"],
      launch_arguments: ["--uitesting"],
      derived_data_path: "./DerivedData",
      buildlog_path: "./logs",
      xcargs: "CODE_SIGN_IDENTITY='' CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO",
      reinstall_app: false,
      clean: true
    )

    UI.success("Screenshots generated in ./fastlane/screenshots/")
  end

  # ============================================================================
  # Convenience: Open in Xcode
  # ============================================================================

  desc "Generate project and open in Xcode"
  lane :open do
    generate
    sh("open ../#{PROJECT_PATH}")
  end

end
